<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Buying Readiness Calculator</title>
    <!-- jsPDF library for PDF generation -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .card.highlight-card {
            border: 3px solid var(--primary);
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
        }

        .card h2 {
            color: var(--gray-800);
            font-size: 1.25rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 .icon {
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--gray-700);
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .form-group .help-text {
            display: block;
            color: var(--gray-600);
            font-size: 0.75rem;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .form-group .help-text a {
            color: var(--primary);
            text-decoration: none;
        }

        .form-group .help-text a:hover {
            text-decoration: underline;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group.large-input input {
            font-size: 1.5rem;
            padding: 16px 20px;
            padding-left: 36px;
            font-weight: 600;
        }

        .form-group.large-input .input-with-prefix span {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .input-with-prefix {
            position: relative;
        }

        .input-with-prefix span {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-600);
            font-weight: 500;
        }

        .input-with-prefix input {
            padding-left: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .results-card {
            grid-column: 1 / -1;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .result-box {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .result-box.highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .result-box.affordable {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .result-box.stretch {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
        }

        .result-box.unaffordable {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
        }

        .result-box h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .result-box .value {
            font-size: 2rem;
            font-weight: 700;
        }

        .result-box .subtext {
            font-size: 0.85rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        .affordability-verdict {
            text-align: center;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
        }

        .affordability-verdict.can-afford {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #10b981;
        }

        .affordability-verdict.stretch {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
        }

        .affordability-verdict.cannot-afford {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
        }

        .affordability-verdict h3 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .affordability-verdict p {
            font-size: 1rem;
            opacity: 0.8;
        }

        .progress-section {
            margin-top: 24px;
        }

        .progress-section h3 {
            color: var(--gray-800);
            margin-bottom: 16px;
        }

        .progress-bar-container {
            background: var(--gray-200);
            border-radius: 10px;
            height: 24px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .progress-bar.good {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .progress-bar.warning {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .progress-bar.danger {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .breakdown-table th, .breakdown-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .breakdown-table th {
            color: var(--gray-600);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .breakdown-table td:last-child {
            text-align: right;
            font-weight: 600;
        }

        .breakdown-table tr:last-child {
            font-weight: 700;
            color: var(--primary);
        }

        .breakdown-table tr:last-child td {
            border-bottom: none;
            padding-top: 16px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.ready {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.almost {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.needs-work {
            background: #fee2e2;
            color: #991b1b;
        }

        .tips-section {
            margin-top: 24px;
            padding: 20px;
            background: #eff6ff;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .tips-section h4 {
            color: var(--primary);
            margin-bottom: 12px;
        }

        .tips-section ul {
            list-style: none;
        }

        .tips-section li {
            padding: 8px 0;
            color: var(--gray-700);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .tips-section li::before {
            content: "üí°";
        }

        .saved-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
        }

        .saved-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .slider-container {
            margin-top: 8px;
        }

        .slider-container input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--gray-200);
            outline: none;
            -webkit-appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider-value {
            text-align: center;
            font-weight: 600;
            color: var(--primary);
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }

        .credit-score-display {
            text-align: center;
            padding: 20px;
        }

        .credit-score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 700;
            color: white;
        }

        .credit-score-circle.excellent {
            background: linear-gradient(135deg, #10b981, #34d399);
        }

        .credit-score-circle.good {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
        }

        .credit-score-circle.fair {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
        }

        .credit-score-circle.poor {
            background: linear-gradient(135deg, #ef4444, #f87171);
        }

        .actions-row {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .actions-row .btn {
            flex: 1;
        }

        .comparison-box {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: center;
            padding: 20px;
            background: var(--gray-50);
            border-radius: 12px;
            margin-top: 20px;
        }

        .comparison-box .vs {
            font-weight: 700;
            color: var(--gray-400);
            font-size: 1.2rem;
        }

        .comparison-item {
            text-align: center;
        }

        .comparison-item .label {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .comparison-item .value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .comparison-item .value.good {
            color: var(--success);
        }

        .comparison-item .value.warning {
            color: var(--warning);
        }

        .comparison-item .value.danger {
            color: var(--danger);
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.75rem;
            }

            .result-box .value {
                font-size: 1.5rem;
            }

            .comparison-box {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .comparison-box .vs {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè† Home Buying Readiness Calculator</h1>
            <p>Enter a home price and see if you're ready to buy</p>
        </header>

        <div class="dashboard">
            <!-- Target Home Price Card - PROMINENT -->
            <div class="card highlight-card" style="grid-column: 1 / -1;">
                <h2><span class="icon">üéØ</span> Target Home Price</h2>
                <p style="color: var(--gray-600); margin-bottom: 16px;">Enter the price of the home you're interested in</p>

                <div class="form-group large-input">
                    <div class="input-with-prefix">
                        <span>$</span>
                        <input type="number" id="targetHomePrice" placeholder="350,000" min="0" step="1000">
                    </div>
                </div>
            </div>

            <!-- Income & Employment Card -->
            <div class="card">
                <h2><span class="icon">üí∞</span> Income & Employment</h2>

                <div class="form-group">
                    <label>Annual Gross Income</label>
                    <span class="help-text">Your total yearly salary BEFORE taxes and deductions. Find this on your W-2 (Box 1) or pay stub (multiply gross pay √ó pay periods).</span>
                    <div class="input-with-prefix">
                        <span>$</span>
                        <input type="number" id="annualIncome" placeholder="75,000" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label>Additional Annual Income</label>
                    <span class="help-text">Include bonuses, overtime, rental income, side jobs, alimony, or investment income you can document for at least 2 years.</span>
                    <div class="input-with-prefix">
                        <span>$</span>
                        <input type="number" id="additionalIncome" placeholder="0" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label>Employment Status</label>
                    <span class="help-text">W-2 employees have easier approval. Self-employed/1099 contractors typically need 2 years of tax returns.</span>
                    <select id="employmentStatus">
                        <option value="employed">Employed (W-2)</option>
                        <option value="self-employed">Self-Employed</option>
                        <option value="contractor">Contractor/1099</option>
                        <option value="retired">Retired</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Years at Current Job</label>
                    <span class="help-text">Lenders prefer 2+ years at the same employer. Less than 2 years is okay if you're in the same field.</span>
                    <input type="number" id="yearsEmployed" placeholder="2" min="0" step="0.5">
                </div>
            </div>

            <!-- Debts & Expenses Card -->
            <div class="card">
                <h2><span class="icon">üí≥</span> Monthly Debts</h2>
                <p style="color: var(--gray-600); font-size: 0.85rem; margin-bottom: 16px;">Enter your minimum required monthly payments, not your total balances.</p>

                <div class="form-group">
                    <label>Car Payment(s)</label>
                    <span class="help-text">Monthly auto loan or lease payments. Include all vehicles you're responsible for.</span>
                    <div class="input-with-prefix">
                        <span>$</span>
                        <input type="number" id="carPayment" placeholder="0" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label>Student Loans</label>
                    <span class="help-text">Monthly student loan payment. If in deferment, use 1% of your total balance or the IBR payment amount.</span>
                    <div class="input-with-prefix">
                        <span>$</span>
                        <input type="number" id="studentLoans" placeholder="0" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label>Credit Card Minimum Payments</label>
                    <span class="help-text">Total of all minimum payments shown on your credit card statements (not your full balance).</span>
                    <div class="input-with-prefix">
                        <span>$</span>
                        <input type="number" id="creditCards" placeholder="0" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label>Other Monthly Debt Payments</label>
                    <span class="help-text">Personal loans, medical debt payments, alimony, child support, or any other recurring debt obligations.</span>
                    <div class="input-with-prefix">
                        <span>$</span>
                        <input type="number" id="otherDebt" placeholder="0" min="0">
                    </div>
                </div>
            </div>

            <!-- Savings & Credit Card -->
            <div class="card">
                <h2><span class="icon">üè¶</span> Savings & Credit</h2>

                <div class="form-group">
                    <label>Total Savings for Home Purchase</label>
                    <span class="help-text">Money you've set aside specifically for buying a home. Include savings accounts, CDs, stocks you can sell, and gift funds.</span>
                    <div class="input-with-prefix">
                        <span>$</span>
                        <input type="number" id="totalSavings" placeholder="25,000" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label>Credit Score (300-850)</label>
                    <span class="help-text">Check free at Credit Karma, Credit Sesame, or your bank's app. 700+ gets better rates, 620 minimum for most loans.</span>
                    <input type="number" id="creditScore" placeholder="720" min="300" max="850">
                </div>

                <div class="credit-score-display hidden" id="creditScoreDisplay">
                    <div class="credit-score-circle" id="creditScoreCircle">
                        <span id="creditScoreValue">720</span>
                    </div>
                    <div id="creditScoreLabel">Good</div>
                </div>

                <div class="form-group">
                    <label>Monthly Savings Rate</label>
                    <span class="help-text">How much you're currently saving each month toward your home purchase. Used to estimate when you'll be ready to buy.</span>
                    <div class="input-with-prefix">
                        <span>$</span>
                        <input type="number" id="monthlySavings" placeholder="500" min="0">
                    </div>
                </div>
            </div>

            <!-- Loan Preferences Card -->
            <div class="card">
                <h2><span class="icon">üìã</span> Loan Preferences</h2>

                <div class="form-group">
                    <label>Down Payment Percentage</label>
                    <span class="help-text">Percentage of home price paid upfront. 20% avoids PMI, but 3-5% is common for first-time buyers.</span>
                    <div class="slider-container">
                        <input type="range" id="downPaymentPercent" min="3" max="25" value="10">
                        <div class="slider-value"><span id="downPaymentValue">10</span>%</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Loan Type</label>
                    <span class="help-text"><strong>Conventional:</strong> Standard loan, 3-20% down. <strong>FHA:</strong> 3.5% down, easier approval. <strong>VA:</strong> 0% down for veterans. <strong>USDA:</strong> 0% down in rural areas.</span>
                    <select id="loanType">
                        <option value="conventional">Conventional</option>
                        <option value="fha">FHA</option>
                        <option value="va">VA</option>
                        <option value="usda">USDA</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Loan Term</label>
                    <span class="help-text"><strong>30 years:</strong> Lower monthly payments, more interest paid. <strong>15 years:</strong> Higher payments, less interest, build equity faster.</span>
                    <select id="loanTerm">
                        <option value="30">30 Years</option>
                        <option value="15">15 Years</option>
                        <option value="20">20 Years</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Estimated Interest Rate (%)</label>
                    <span class="help-text">Current mortgage rate you expect to get. Check Bankrate or NerdWallet for today's rates. Depends on credit score and market conditions.</span>
                    <input type="number" id="interestRate" placeholder="6.5" min="0" max="15" step="0.125">
                </div>

                <button class="btn btn-primary" onclick="calculateAffordability()">
                    Can I Afford This Home?
                </button>
            </div>

            <!-- Results Card -->
            <div class="card results-card hidden" id="resultsCard">
                <h2><span class="icon">üìä</span> Your Results for <span id="resultHomePrice">$0</span></h2>

                <!-- Affordability Verdict -->
                <div class="affordability-verdict" id="affordabilityVerdict">
                    <h3 id="verdictTitle">Calculating...</h3>
                    <p id="verdictDescription"></p>
                </div>

                <div class="results-grid">
                    <div class="result-box" id="monthlyPaymentBox">
                        <h3>Monthly Payment</h3>
                        <div class="value" id="monthlyPayment">$0</div>
                        <div class="subtext">Principal + Interest + Taxes + Insurance</div>
                    </div>

                    <div class="result-box">
                        <h3>Down Payment Needed</h3>
                        <div class="value" id="downPaymentNeeded">$0</div>
                        <div class="subtext" id="downPaymentStatus">You have $0 saved</div>
                    </div>

                    <div class="result-box">
                        <h3>Closing Costs (Est.)</h3>
                        <div class="value" id="closingCosts">$0</div>
                        <div class="subtext">~3% of home price</div>
                    </div>

                    <div class="result-box">
                        <h3>Total Cash Needed</h3>
                        <div class="value" id="totalCashNeeded">$0</div>
                        <div class="subtext">Down payment + closing + reserves</div>
                    </div>
                </div>

                <!-- DTI Comparison -->
                <div class="comparison-box">
                    <div class="comparison-item">
                        <div class="label">Your Housing DTI</div>
                        <div class="value" id="yourFrontDTI">0%</div>
                    </div>
                    <div class="vs">vs</div>
                    <div class="comparison-item">
                        <div class="label">Recommended Max</div>
                        <div class="value">28%</div>
                    </div>
                </div>

                <div class="comparison-box">
                    <div class="comparison-item">
                        <div class="label">Your Total DTI</div>
                        <div class="value" id="yourBackDTI">0%</div>
                    </div>
                    <div class="vs">vs</div>
                    <div class="comparison-item">
                        <div class="label">Recommended Max</div>
                        <div class="value">36%</div>
                    </div>
                </div>

                <!-- Monthly Payment Breakdown -->
                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>Monthly Cost Breakdown</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="paymentBreakdown">
                    </tbody>
                </table>

                <!-- Savings Progress -->
                <div class="progress-section">
                    <h3>Savings Progress</h3>
                    <div class="progress-bar-container">
                        <div class="progress-bar good" id="savingsProgressBar">0%</div>
                    </div>
                    <p id="savingsStatus"></p>
                </div>

                <!-- Readiness Status -->
                <div style="margin-top: 24px; text-align: center;">
                    <h3 style="margin-bottom: 12px;">Your Readiness Status</h3>
                    <span class="status-badge" id="readinessStatus">Calculating...</span>
                    <p style="margin-top: 12px; color: var(--gray-600);" id="monthsUntilReadyText"></p>
                </div>

                <!-- Tips Section -->
                <div class="tips-section" id="tipsSection">
                    <h4>What You Need to Do</h4>
                    <ul id="tipsList"></ul>
                </div>

                <!-- Action Buttons -->
                <div class="actions-row">
                    <button class="btn btn-secondary" onclick="resetCalculator()">Reset</button>
                    <button class="btn btn-secondary" onclick="exportJSON()">Export JSON</button>
                    <button class="btn btn-primary" onclick="exportPDF()">üìÑ Download PDF Report</button>
                </div>
            </div>
        </div>
    </div>

    <div class="saved-indicator" id="savedIndicator">
        ‚úì Progress Saved
    </div>

    <script>
        // Initialize and load saved data
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            setupAutoSave();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Down payment slider
            const slider = document.getElementById('downPaymentPercent');
            slider.addEventListener('input', function() {
                document.getElementById('downPaymentValue').textContent = this.value;
            });

            // Credit score display
            const creditScoreInput = document.getElementById('creditScore');
            creditScoreInput.addEventListener('input', updateCreditScoreDisplay);
        }

        function updateCreditScoreDisplay() {
            const score = parseInt(document.getElementById('creditScore').value) || 0;
            if (score >= 300 && score <= 850) {
                const display = document.getElementById('creditScoreDisplay');
                const circle = document.getElementById('creditScoreCircle');
                const value = document.getElementById('creditScoreValue');
                const label = document.getElementById('creditScoreLabel');

                display.classList.remove('hidden');
                value.textContent = score;

                circle.className = 'credit-score-circle';
                if (score >= 760) {
                    circle.classList.add('excellent');
                    label.textContent = 'Excellent - Best rates available';
                } else if (score >= 700) {
                    circle.classList.add('good');
                    label.textContent = 'Good - Competitive rates';
                } else if (score >= 620) {
                    circle.classList.add('fair');
                    label.textContent = 'Fair - Higher rates likely';
                } else {
                    circle.classList.add('poor');
                    label.textContent = 'Needs improvement';
                }
            }
        }

        function calculateAffordability() {
            // Get target home price
            const targetHomePrice = parseFloat(document.getElementById('targetHomePrice').value) || 0;

            if (targetHomePrice <= 0) {
                alert('Please enter a target home price');
                return;
            }

            // Get all inputs
            const annualIncome = parseFloat(document.getElementById('annualIncome').value) || 0;
            const additionalIncome = parseFloat(document.getElementById('additionalIncome').value) || 0;
            const totalAnnualIncome = annualIncome + additionalIncome;
            const monthlyIncome = totalAnnualIncome / 12;

            if (monthlyIncome <= 0) {
                alert('Please enter your annual income');
                return;
            }

            const carPayment = parseFloat(document.getElementById('carPayment').value) || 0;
            const studentLoans = parseFloat(document.getElementById('studentLoans').value) || 0;
            const creditCards = parseFloat(document.getElementById('creditCards').value) || 0;
            const otherDebt = parseFloat(document.getElementById('otherDebt').value) || 0;
            const totalMonthlyDebt = carPayment + studentLoans + creditCards + otherDebt;

            const totalSavings = parseFloat(document.getElementById('totalSavings').value) || 0;
            const creditScore = parseInt(document.getElementById('creditScore').value) || 720;
            const monthlySavings = parseFloat(document.getElementById('monthlySavings').value) || 0;

            const downPaymentPercent = parseFloat(document.getElementById('downPaymentPercent').value) / 100;
            const loanType = document.getElementById('loanType').value;
            const loanTerm = parseInt(document.getElementById('loanTerm').value);
            const interestRate = (parseFloat(document.getElementById('interestRate').value) || 6.5) / 100 / 12;

            // Calculate costs for the TARGET home price
            const homePrice = targetHomePrice;

            // Estimate property tax (1.2% annually) and insurance (0.5% annually)
            const annualTaxRate = 0.012;
            const annualInsuranceRate = 0.005;

            // PMI if down payment < 20%
            const pmiRate = downPaymentPercent < 0.20 ? 0.005 : 0;

            // Calculate all the details for the target home price
            const downPaymentNeeded = homePrice * downPaymentPercent;
            const loanAmount = homePrice * (1 - downPaymentPercent);
            const monthlyPI = calculateMonthlyPayment(loanAmount, interestRate, loanTerm * 12);
            const monthlyTax = homePrice * annualTaxRate / 12;
            const monthlyInsurance = homePrice * annualInsuranceRate / 12;
            const monthlyPMI = downPaymentPercent < 0.20 ? homePrice * pmiRate / 12 : 0;
            const totalMonthlyPayment = monthlyPI + monthlyTax + monthlyInsurance + monthlyPMI;

            const closingCosts = homePrice * 0.03;
            const reservesNeeded = totalMonthlyPayment * 3; // 3 months reserves
            const totalCashNeeded = downPaymentNeeded + closingCosts + reservesNeeded;

            // Calculate DTI ratios
            const frontEndDTI = (totalMonthlyPayment / monthlyIncome) * 100;
            const backEndDTI = ((totalMonthlyPayment + totalMonthlyDebt) / monthlyIncome) * 100;

            // Determine affordability
            let canAfford = frontEndDTI <= 28 && backEndDTI <= 36;
            let isStretch = !canAfford && frontEndDTI <= 33 && backEndDTI <= 43;

            // Display results
            document.getElementById('resultsCard').classList.remove('hidden');
            document.getElementById('resultHomePrice').textContent = formatCurrency(homePrice);

            // Affordability verdict
            const verdict = document.getElementById('affordabilityVerdict');
            const verdictTitle = document.getElementById('verdictTitle');
            const verdictDesc = document.getElementById('verdictDescription');

            verdict.className = 'affordability-verdict';
            if (canAfford) {
                verdict.classList.add('can-afford');
                verdictTitle.textContent = '‚úÖ Yes, You Can Afford This Home!';
                verdictDesc.textContent = `This home fits comfortably within your budget. Your monthly payment would be ${formatCurrency(totalMonthlyPayment)}.`;
            } else if (isStretch) {
                verdict.classList.add('stretch');
                verdictTitle.textContent = '‚ö†Ô∏è This Home Is a Stretch';
                verdictDesc.textContent = `You might qualify, but it would stretch your budget. Consider a lower price or pay down debt first.`;
            } else {
                verdict.classList.add('cannot-afford');
                verdictTitle.textContent = '‚ùå This Home Is Above Your Budget';
                verdictDesc.textContent = `Based on your income and debts, this home would put too much strain on your finances.`;
            }

            // Monthly payment box coloring
            const paymentBox = document.getElementById('monthlyPaymentBox');
            paymentBox.className = 'result-box';
            if (canAfford) {
                paymentBox.classList.add('affordable');
            } else if (isStretch) {
                paymentBox.classList.add('stretch');
            } else {
                paymentBox.classList.add('unaffordable');
            }

            document.getElementById('monthlyPayment').textContent = formatCurrency(totalMonthlyPayment);
            document.getElementById('downPaymentNeeded').textContent = formatCurrency(downPaymentNeeded);

            const savingsGap = downPaymentNeeded - totalSavings;
            if (savingsGap > 0) {
                document.getElementById('downPaymentStatus').textContent = `You need ${formatCurrency(savingsGap)} more`;
            } else {
                document.getElementById('downPaymentStatus').textContent = `You have enough! (${formatCurrency(totalSavings)} saved)`;
            }

            document.getElementById('closingCosts').textContent = formatCurrency(closingCosts);
            document.getElementById('totalCashNeeded').textContent = formatCurrency(totalCashNeeded);

            // DTI displays
            const frontDTIEl = document.getElementById('yourFrontDTI');
            frontDTIEl.textContent = frontEndDTI.toFixed(1) + '%';
            frontDTIEl.className = 'value ' + (frontEndDTI <= 28 ? 'good' : frontEndDTI <= 33 ? 'warning' : 'danger');

            const backDTIEl = document.getElementById('yourBackDTI');
            backDTIEl.textContent = backEndDTI.toFixed(1) + '%';
            backDTIEl.className = 'value ' + (backEndDTI <= 36 ? 'good' : backEndDTI <= 43 ? 'warning' : 'danger');

            // Payment breakdown
            const breakdownHTML = `
                <tr><td>Principal & Interest</td><td>${formatCurrency(monthlyPI)}</td></tr>
                <tr><td>Property Tax (est.)</td><td>${formatCurrency(monthlyTax)}</td></tr>
                <tr><td>Homeowners Insurance (est.)</td><td>${formatCurrency(monthlyInsurance)}</td></tr>
                ${monthlyPMI > 0 ? `<tr><td>PMI</td><td>${formatCurrency(monthlyPMI)}</td></tr>` : ''}
                <tr><td>Total Monthly Payment</td><td>${formatCurrency(totalMonthlyPayment)}</td></tr>
            `;
            document.getElementById('paymentBreakdown').innerHTML = breakdownHTML;

            // Savings progress
            const savingsProgress = totalSavings / totalCashNeeded;
            const savingsBar = document.getElementById('savingsProgressBar');
            const savingsPercent = Math.min(savingsProgress * 100, 100);
            savingsBar.style.width = savingsPercent + '%';
            savingsBar.textContent = savingsPercent.toFixed(0) + '%';
            savingsBar.className = 'progress-bar ' + (savingsProgress >= 1 ? 'good' : savingsProgress >= 0.5 ? 'warning' : 'danger');

            document.getElementById('savingsStatus').textContent =
                `You have ${formatCurrency(totalSavings)} of ${formatCurrency(totalCashNeeded)} needed`;

            // Readiness status
            let readinessClass, readinessText;
            if (savingsProgress >= 1 && canAfford && creditScore >= 700) {
                readinessClass = 'ready';
                readinessText = '‚úÖ Ready to Buy This Home!';
            } else if (savingsProgress >= 0.7 && (canAfford || isStretch) && creditScore >= 620) {
                readinessClass = 'almost';
                readinessText = 'üî∂ Almost Ready';
            } else {
                readinessClass = 'needs-work';
                readinessText = 'üî¥ Needs More Preparation';
            }

            const statusBadge = document.getElementById('readinessStatus');
            statusBadge.className = 'status-badge ' + readinessClass;
            statusBadge.textContent = readinessText;

            // Months until ready
            const cashGap = totalCashNeeded - totalSavings;
            if (cashGap > 0 && monthlySavings > 0) {
                const monthsNeeded = Math.ceil(cashGap / monthlySavings);
                const readyDate = new Date();
                readyDate.setMonth(readyDate.getMonth() + monthsNeeded);
                document.getElementById('monthsUntilReadyText').textContent =
                    `At your current savings rate, you'll have enough cash in ${monthsNeeded} months (${readyDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })})`;
            } else if (cashGap <= 0) {
                document.getElementById('monthsUntilReadyText').textContent = 'You have enough savings!';
            } else {
                document.getElementById('monthsUntilReadyText').textContent = 'Set a monthly savings goal to see your timeline';
            }

            // Generate tips
            const tips = [];

            if (!canAfford && !isStretch) {
                const maxAffordable = calculateMaxAffordablePrice(monthlyIncome, totalMonthlyDebt, downPaymentPercent, interestRate, loanTerm);
                tips.push(`Based on your income, consider homes around ${formatCurrency(maxAffordable)} or less.`);
            }

            if (backEndDTI > 36) {
                const debtToPayOff = ((backEndDTI - 36) / 100) * monthlyIncome;
                tips.push(`Pay down ${formatCurrency(debtToPayOff)}/month in debt to reach a healthy 36% DTI ratio.`);
            }

            if (creditScore < 700) {
                tips.push('Improve your credit score above 700 to get better interest rates and save thousands over the life of your loan.');
            }

            if (cashGap > 0) {
                tips.push(`Save ${formatCurrency(cashGap)} more for down payment, closing costs, and reserves.`);
            }

            if (downPaymentPercent < 0.20) {
                const pmiSavings = monthlyPMI * loanTerm * 12;
                tips.push(`Increasing down payment to 20% would eliminate ${formatCurrency(monthlyPMI)}/month in PMI (${formatCurrency(pmiSavings)} total savings).`);
            }

            if (canAfford && savingsProgress >= 1 && creditScore >= 700) {
                tips.push('You\'re in great shape! Consider getting pre-approved to lock in your rate and show sellers you\'re serious.');
            }

            document.getElementById('tipsList').innerHTML = tips.map(tip => `<li>${tip}</li>`).join('');

            // Scroll to results
            document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });

            // Save data
            saveData();
        }

        function calculateMaxAffordablePrice(monthlyIncome, totalMonthlyDebt, downPaymentPercent, monthlyInterestRate, loanTermYears) {
            const annualTaxRate = 0.012;
            const annualInsuranceRate = 0.005;
            const monthlyTaxInsuranceRate = (annualTaxRate + annualInsuranceRate) / 12;
            const pmiRate = downPaymentPercent < 0.20 ? 0.005 / 12 : 0;

            let maxPrice = 0;
            for (let price = 50000; price <= 2000000; price += 5000) {
                const loanAmount = price * (1 - downPaymentPercent);
                const monthlyPI = calculateMonthlyPayment(loanAmount, monthlyInterestRate, loanTermYears * 12);
                const monthlyTaxInsurance = price * monthlyTaxInsuranceRate;
                const monthlyPMI = price * pmiRate;
                const totalMonthly = monthlyPI + monthlyTaxInsurance + monthlyPMI;

                const frontEndDTI = totalMonthly / monthlyIncome;
                const backEndDTI = (totalMonthly + totalMonthlyDebt) / monthlyIncome;

                if (frontEndDTI <= 0.28 && backEndDTI <= 0.36) {
                    maxPrice = price;
                } else {
                    break;
                }
            }
            return maxPrice;
        }

        function calculateMonthlyPayment(principal, monthlyRate, numPayments) {
            if (monthlyRate === 0) return principal / numPayments;
            return principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                   (Math.pow(1 + monthlyRate, numPayments) - 1);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function saveData() {
            const data = {
                targetHomePrice: document.getElementById('targetHomePrice').value,
                annualIncome: document.getElementById('annualIncome').value,
                additionalIncome: document.getElementById('additionalIncome').value,
                employmentStatus: document.getElementById('employmentStatus').value,
                yearsEmployed: document.getElementById('yearsEmployed').value,
                carPayment: document.getElementById('carPayment').value,
                studentLoans: document.getElementById('studentLoans').value,
                creditCards: document.getElementById('creditCards').value,
                otherDebt: document.getElementById('otherDebt').value,
                totalSavings: document.getElementById('totalSavings').value,
                creditScore: document.getElementById('creditScore').value,
                monthlySavings: document.getElementById('monthlySavings').value,
                downPaymentPercent: document.getElementById('downPaymentPercent').value,
                loanType: document.getElementById('loanType').value,
                loanTerm: document.getElementById('loanTerm').value,
                interestRate: document.getElementById('interestRate').value,
                savedAt: new Date().toISOString()
            };

            localStorage.setItem('homeBuyingCalculator', JSON.stringify(data));
            showSavedIndicator();
        }

        function loadSavedData() {
            const saved = localStorage.getItem('homeBuyingCalculator');
            if (saved) {
                const data = JSON.parse(saved);

                document.getElementById('targetHomePrice').value = data.targetHomePrice || '';
                document.getElementById('annualIncome').value = data.annualIncome || '';
                document.getElementById('additionalIncome').value = data.additionalIncome || '';
                document.getElementById('employmentStatus').value = data.employmentStatus || 'employed';
                document.getElementById('yearsEmployed').value = data.yearsEmployed || '';
                document.getElementById('carPayment').value = data.carPayment || '';
                document.getElementById('studentLoans').value = data.studentLoans || '';
                document.getElementById('creditCards').value = data.creditCards || '';
                document.getElementById('otherDebt').value = data.otherDebt || '';
                document.getElementById('totalSavings').value = data.totalSavings || '';
                document.getElementById('creditScore').value = data.creditScore || '';
                document.getElementById('monthlySavings').value = data.monthlySavings || '';
                document.getElementById('downPaymentPercent').value = data.downPaymentPercent || 10;
                document.getElementById('downPaymentValue').textContent = data.downPaymentPercent || 10;
                document.getElementById('loanType').value = data.loanType || 'conventional';
                document.getElementById('loanTerm').value = data.loanTerm || '30';
                document.getElementById('interestRate').value = data.interestRate || '';

                updateCreditScoreDisplay();
            }
        }

        function setupAutoSave() {
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', saveData);
            });
        }

        function showSavedIndicator() {
            const indicator = document.getElementById('savedIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function resetCalculator() {
            if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
                localStorage.removeItem('homeBuyingCalculator');
                location.reload();
            }
        }

        function getResultsData() {
            return {
                generatedAt: new Date().toLocaleString(),
                targetHomePrice: document.getElementById('targetHomePrice').value,
                monthlyPayment: document.getElementById('monthlyPayment').textContent,
                downPaymentNeeded: document.getElementById('downPaymentNeeded').textContent,
                closingCosts: document.getElementById('closingCosts').textContent,
                totalCashNeeded: document.getElementById('totalCashNeeded').textContent,
                readinessStatus: document.getElementById('readinessStatus').textContent,
                dti: {
                    housingDTI: document.getElementById('yourFrontDTI').textContent,
                    totalDTI: document.getElementById('yourBackDTI').textContent
                },
                inputs: {
                    annualIncome: document.getElementById('annualIncome').value,
                    additionalIncome: document.getElementById('additionalIncome').value,
                    creditScore: document.getElementById('creditScore').value,
                    totalSavings: document.getElementById('totalSavings').value,
                    monthlySavings: document.getElementById('monthlySavings').value,
                    downPaymentPercent: document.getElementById('downPaymentPercent').value + '%',
                    loanType: document.getElementById('loanType').value,
                    loanTerm: document.getElementById('loanTerm').value + ' years',
                    interestRate: document.getElementById('interestRate').value + '%'
                },
                monthlyDebts: {
                    carPayment: document.getElementById('carPayment').value,
                    studentLoans: document.getElementById('studentLoans').value,
                    creditCards: document.getElementById('creditCards').value,
                    otherDebt: document.getElementById('otherDebt').value
                }
            };
        }

        function exportJSON() {
            const resultsCard = document.getElementById('resultsCard');
            if (resultsCard.classList.contains('hidden')) {
                alert('Please calculate your affordability first before exporting results.');
                return;
            }

            const results = getResultsData();
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'home-buying-results.json';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        function exportPDF() {
            const resultsCard = document.getElementById('resultsCard');
            if (resultsCard.classList.contains('hidden')) {
                alert('Please calculate your affordability first before exporting results.');
                return;
            }

            // Check if jsPDF is loaded
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert('PDF library is still loading. Please try again in a moment.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const data = getResultsData();

            // Colors
            const primaryColor = [37, 99, 235];
            const successColor = [16, 185, 129];
            const warningColor = [245, 158, 11];
            const dangerColor = [239, 68, 68];
            const grayColor = [107, 114, 128];
            const darkGray = [31, 41, 55];

            let yPos = 20;
            const leftMargin = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const contentWidth = pageWidth - 40;

            // Helper function to add new page if needed
            function checkNewPage(neededSpace) {
                if (yPos + neededSpace > 270) {
                    doc.addPage();
                    yPos = 20;
                }
            }

            // Title
            doc.setFontSize(24);
            doc.setTextColor(...primaryColor);
            doc.text('Home Buying Readiness Report', pageWidth / 2, yPos, { align: 'center' });
            yPos += 10;

            // Subtitle
            doc.setFontSize(10);
            doc.setTextColor(...grayColor);
            doc.text(`Generated on ${data.generatedAt}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;

            // Divider line
            doc.setDrawColor(...primaryColor);
            doc.setLineWidth(0.5);
            doc.line(leftMargin, yPos, pageWidth - leftMargin, yPos);
            yPos += 15;

            // Target Home Price and Verdict Box
            const verdict = data.readinessStatus;
            let verdictColor = dangerColor;
            let verdictBg = [254, 226, 226];
            if (verdict.includes('Ready') || verdict.includes('‚úÖ')) {
                verdictColor = successColor;
                verdictBg = [209, 250, 229];
            } else if (verdict.includes('Almost') || verdict.includes('üî∂')) {
                verdictColor = warningColor;
                verdictBg = [254, 243, 199];
            }

            // Verdict box background
            doc.setFillColor(...verdictBg);
            doc.roundedRect(leftMargin, yPos, contentWidth, 30, 3, 3, 'F');

            // Verdict border
            doc.setDrawColor(...verdictColor);
            doc.setLineWidth(0.8);
            doc.roundedRect(leftMargin, yPos, contentWidth, 30, 3, 3, 'S');

            // Target price text
            const targetPrice = data.targetHomePrice ? `$${parseInt(data.targetHomePrice).toLocaleString()}` : 'N/A';
            doc.setFontSize(11);
            doc.setTextColor(...grayColor);
            doc.text(`Target Home Price: ${targetPrice}`, pageWidth / 2, yPos + 10, { align: 'center' });

            // Verdict text
            doc.setFontSize(14);
            doc.setTextColor(...verdictColor);
            const cleanVerdict = verdict.replace('‚úÖ', '‚úì').replace('üî∂', '!').replace('üî¥', '‚úó');
            doc.text(cleanVerdict, pageWidth / 2, yPos + 22, { align: 'center' });
            yPos += 40;

            // Key Results Section
            doc.setFontSize(14);
            doc.setTextColor(...darkGray);
            doc.text('Key Results', leftMargin, yPos);
            yPos += 8;

            // Results table
            const resultsData = [
                ['Monthly Payment', data.monthlyPayment],
                ['Down Payment Needed', data.downPaymentNeeded],
                ['Closing Costs (Est.)', data.closingCosts],
                ['Total Cash Needed', data.totalCashNeeded]
            ];

            resultsData.forEach((row, index) => {
                const rowY = yPos + (index * 10);
                // Alternate row background
                if (index % 2 === 0) {
                    doc.setFillColor(243, 244, 246);
                    doc.rect(leftMargin, rowY - 3, contentWidth, 10, 'F');
                }
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                doc.text(row[0], leftMargin + 5, rowY + 4);
                doc.setTextColor(...darkGray);
                doc.setFont(undefined, 'bold');
                doc.text(row[1], pageWidth - leftMargin - 5, rowY + 4, { align: 'right' });
                doc.setFont(undefined, 'normal');
            });
            yPos += 50;

            // DTI Analysis Section
            checkNewPage(60);
            doc.setFontSize(14);
            doc.setTextColor(...darkGray);
            doc.text('Debt-to-Income Analysis', leftMargin, yPos);
            yPos += 10;

            // DTI Header
            doc.setFillColor(...primaryColor);
            doc.rect(leftMargin, yPos - 3, contentWidth, 10, 'F');
            doc.setFontSize(9);
            doc.setTextColor(255, 255, 255);
            doc.text('Metric', leftMargin + 10, yPos + 4);
            doc.text('Your Value', leftMargin + 55, yPos + 4);
            doc.text('Recommended', leftMargin + 100, yPos + 4);
            doc.text('Status', leftMargin + 145, yPos + 4);
            yPos += 10;

            // DTI Rows
            const housingDTI = data.dti.housingDTI;
            const totalDTI = data.dti.totalDTI;

            function getDTIStatus(dtiStr, threshold) {
                try {
                    const val = parseFloat(dtiStr.replace('%', ''));
                    if (val <= threshold) return { text: '‚úì Good', color: successColor };
                    if (val <= threshold + 7) return { text: '! High', color: warningColor };
                    return { text: '‚úó Too High', color: dangerColor };
                } catch (e) { return { text: 'N/A', color: grayColor }; }
            }

            const housingStatus = getDTIStatus(housingDTI, 28);
            const totalStatus = getDTIStatus(totalDTI, 36);

            const dtiRows = [
                ['Housing DTI', housingDTI, '28%', housingStatus],
                ['Total DTI', totalDTI, '36%', totalStatus]
            ];

            dtiRows.forEach((row, index) => {
                const rowY = yPos + (index * 10);
                doc.setFillColor(249, 250, 251);
                doc.rect(leftMargin, rowY - 3, contentWidth, 10, 'F');
                doc.setFontSize(9);
                doc.setTextColor(...darkGray);
                doc.text(row[0], leftMargin + 10, rowY + 4);
                doc.setFont(undefined, 'bold');
                doc.text(row[1], leftMargin + 55, rowY + 4);
                doc.setFont(undefined, 'normal');
                doc.text(row[2], leftMargin + 100, rowY + 4);
                doc.setTextColor(...row[3].color);
                doc.text(row[3].text, leftMargin + 145, rowY + 4);
            });
            yPos += 30;

            // Financial Profile Section
            checkNewPage(80);
            doc.setFontSize(14);
            doc.setTextColor(...darkGray);
            doc.text('Your Financial Profile', leftMargin, yPos);
            yPos += 10;

            // Income Header
            doc.setFillColor(...primaryColor);
            doc.rect(leftMargin, yPos - 3, contentWidth, 8, 'F');
            doc.setFontSize(9);
            doc.setTextColor(255, 255, 255);
            doc.text('Income Information', pageWidth / 2, yPos + 3, { align: 'center' });
            yPos += 8;

            const incomeData = [
                ['Annual Gross Income', `$${parseInt(data.inputs.annualIncome || 0).toLocaleString()}`],
                ['Additional Income', `$${parseInt(data.inputs.additionalIncome || 0).toLocaleString()}`],
                ['Credit Score', data.inputs.creditScore || 'N/A'],
                ['Total Savings', `$${parseInt(data.inputs.totalSavings || 0).toLocaleString()}`],
                ['Monthly Savings Rate', `$${parseInt(data.inputs.monthlySavings || 0).toLocaleString()}`]
            ];

            incomeData.forEach((row, index) => {
                const rowY = yPos + (index * 8);
                if (index % 2 === 0) {
                    doc.setFillColor(243, 244, 246);
                    doc.rect(leftMargin, rowY - 2, contentWidth, 8, 'F');
                }
                doc.setFontSize(9);
                doc.setTextColor(...grayColor);
                doc.text(row[0], leftMargin + 5, rowY + 4);
                doc.setTextColor(...darkGray);
                doc.setFont(undefined, 'bold');
                doc.text(row[1], pageWidth - leftMargin - 5, rowY + 4, { align: 'right' });
                doc.setFont(undefined, 'normal');
            });
            yPos += 50;

            // Monthly Debts Header
            checkNewPage(60);
            doc.setFillColor(124, 58, 237);
            doc.rect(leftMargin, yPos - 3, contentWidth, 8, 'F');
            doc.setFontSize(9);
            doc.setTextColor(255, 255, 255);
            doc.text('Monthly Debt Payments', pageWidth / 2, yPos + 3, { align: 'center' });
            yPos += 8;

            const debtsData = [
                ['Car Payment(s)', `$${parseInt(data.monthlyDebts.carPayment || 0).toLocaleString()}`],
                ['Student Loans', `$${parseInt(data.monthlyDebts.studentLoans || 0).toLocaleString()}`],
                ['Credit Card Minimums', `$${parseInt(data.monthlyDebts.creditCards || 0).toLocaleString()}`],
                ['Other Debts', `$${parseInt(data.monthlyDebts.otherDebt || 0).toLocaleString()}`]
            ];

            const totalDebt = parseInt(data.monthlyDebts.carPayment || 0) +
                              parseInt(data.monthlyDebts.studentLoans || 0) +
                              parseInt(data.monthlyDebts.creditCards || 0) +
                              parseInt(data.monthlyDebts.otherDebt || 0);

            debtsData.forEach((row, index) => {
                const rowY = yPos + (index * 8);
                if (index % 2 === 0) {
                    doc.setFillColor(243, 244, 246);
                    doc.rect(leftMargin, rowY - 2, contentWidth, 8, 'F');
                }
                doc.setFontSize(9);
                doc.setTextColor(...grayColor);
                doc.text(row[0], leftMargin + 5, rowY + 4);
                doc.setTextColor(...darkGray);
                doc.setFont(undefined, 'bold');
                doc.text(row[1], pageWidth - leftMargin - 5, rowY + 4, { align: 'right' });
                doc.setFont(undefined, 'normal');
            });
            yPos += 35;

            // Total debt row
            doc.setFillColor(237, 233, 254);
            doc.rect(leftMargin, yPos - 2, contentWidth, 8, 'F');
            doc.setFontSize(9);
            doc.setTextColor(...darkGray);
            doc.setFont(undefined, 'bold');
            doc.text('Total Monthly Debt', leftMargin + 5, yPos + 4);
            doc.text(`$${totalDebt.toLocaleString()}`, pageWidth - leftMargin - 5, yPos + 4, { align: 'right' });
            doc.setFont(undefined, 'normal');
            yPos += 15;

            // Loan Configuration
            checkNewPage(50);
            doc.setFontSize(14);
            doc.setTextColor(...darkGray);
            doc.text('Loan Configuration', leftMargin, yPos);
            yPos += 10;

            const loanData = [
                ['Down Payment', data.inputs.downPaymentPercent],
                ['Loan Type', data.inputs.loanType.charAt(0).toUpperCase() + data.inputs.loanType.slice(1)],
                ['Loan Term', data.inputs.loanTerm],
                ['Interest Rate', data.inputs.interestRate]
            ];

            loanData.forEach((row, index) => {
                const rowY = yPos + (index * 8);
                if (index % 2 === 0) {
                    doc.setFillColor(243, 244, 246);
                    doc.rect(leftMargin, rowY - 2, contentWidth, 8, 'F');
                }
                doc.setFontSize(9);
                doc.setTextColor(...grayColor);
                doc.text(row[0], leftMargin + 5, rowY + 4);
                doc.setTextColor(...darkGray);
                doc.setFont(undefined, 'bold');
                doc.text(row[1], pageWidth - leftMargin - 5, rowY + 4, { align: 'right' });
                doc.setFont(undefined, 'normal');
            });
            yPos += 45;

            // Next Steps Section
            checkNewPage(60);
            doc.setFontSize(14);
            doc.setTextColor(...darkGray);
            doc.text('Recommended Next Steps', leftMargin, yPos);
            yPos += 10;

            const nextSteps = [];
            const savings = parseFloat(data.inputs.totalSavings || 0);
            const totalCashNeeded = parseFloat(data.totalCashNeeded.replace(/[$,]/g, '') || 0);
            const creditScore = parseInt(data.inputs.creditScore || 0);

            if (savings < totalCashNeeded) {
                const gap = totalCashNeeded - savings;
                nextSteps.push(`Save $${gap.toLocaleString()} more for down payment, closing costs, and reserves`);
            }

            if (creditScore < 700 && creditScore > 0) {
                nextSteps.push('Work on improving your credit score above 700 for better interest rates');
            } else if (creditScore >= 700) {
                nextSteps.push('Your credit score is good - consider getting pre-approved for a mortgage');
            }

            if (verdict.includes('Ready') || verdict.includes('‚úÖ')) {
                nextSteps.push('You\'re ready! Start interviewing real estate agents');
                nextSteps.push('Get pre-approved with 2-3 lenders to compare rates');
            } else if (verdict.includes('Almost') || verdict.includes('üî∂')) {
                nextSteps.push('Consider paying down existing debts to improve your DTI ratio');
            } else {
                nextSteps.push('Focus on increasing income or reducing monthly debts');
                nextSteps.push('Consider looking at homes in a lower price range');
            }

            doc.setFontSize(10);
            doc.setTextColor(...darkGray);
            nextSteps.forEach((step, index) => {
                const stepY = yPos + (index * 8);
                doc.text(`${index + 1}. ${step}`, leftMargin + 5, stepY);
            });
            yPos += nextSteps.length * 8 + 20;

            // Footer
            checkNewPage(30);
            doc.setDrawColor(...grayColor);
            doc.setLineWidth(0.3);
            doc.line(leftMargin, yPos, pageWidth - leftMargin, yPos);
            yPos += 8;

            doc.setFontSize(8);
            doc.setTextColor(...grayColor);
            doc.text('This report is for informational purposes only and does not constitute financial advice.', pageWidth / 2, yPos, { align: 'center' });
            yPos += 5;
            doc.text('Consult with a mortgage professional for personalized guidance.', pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            doc.text('Generated by Home Buying Readiness Calculator', pageWidth / 2, yPos, { align: 'center' });

            // Save the PDF
            doc.save('home-buying-report.pdf');
            } catch (error) {
                console.error('PDF Export Error:', error);
                alert('Error generating PDF: ' + error.message + '\n\nPlease try refreshing the page.');
            }
        }
    </script>
</body>
</html>
